{% extends "base.html" %}

{% block title %}Configuration - ReolinkANPR{% endblock %}

{% block content %}
    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="mb-4"><i class="bi bi-gear"></i> Configuration</h2>

        <div id="alertContainer"></div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button" role="tab">
                    <i class="bi bi-camera"></i> Camera
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alpr-tab" data-bs-toggle="tab" data-bs-target="#alpr" type="button" role="tab">
                    <i class="bi bi-card-text"></i> ALPR
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                    <i class="bi bi-bell"></i> Notifications
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="camera-control-tab" data-bs-toggle="tab" data-bs-target="#camera-control" type="button" role="tab">
                    <i class="bi bi-sliders"></i> Camera Control
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                    <i class="bi bi-gear-wide-connected"></i> System
                </button>
            </li>
        </ul>

        <form id="configForm">
            <!-- Tab Content -->
            <div class="tab-content" id="configTabContent">
                
                <!-- Camera Tab -->
                <div class="tab-pane fade show active" id="camera" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Camera Connection</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="camera_name" class="form-label">Camera Name</label>
                                    <input type="text" class="form-control" id="camera_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="camera_host" class="form-label">Camera IP / Host</label>
                                    <input type="text" class="form-control" id="camera_host" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="camera_username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="camera_username" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="camera_password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="camera_password" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="camera_channel" class="form-label">Camera Channel</label>
                                    <input type="number" class="form-control" id="camera_channel" min="0" required>
                                    <small class="text-muted">Channel number (usually 0 for single camera)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="recording_duration" class="form-label">Recording Duration (seconds)</label>
                                    <input type="number" class="form-control" id="recording_duration" min="1" max="30" required>
                                    <small class="text-muted">Duration to record when vehicle detected</small>
                                </div>
                            </div>

                            <h5 class="card-title mb-3 mt-4">RTSP Streaming</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="rtsp_enabled" disabled>
                                        <label class="form-check-label" for="rtsp_enabled">
                                            RTSP Enabled (Port 554)
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2" id="rtsp_status">
                                        <span class="spinner-border spinner-border-sm me-2"></span>Checking status...
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ALPR Tab -->
                <div class="tab-pane fade" id="alpr" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">ALPR Models</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="detection_model" class="form-label">Detection Model</label>
                                    <select class="form-select" id="detection_model" required>
                                        <option value="yolo-v9-t-256-license-plate-end2end">YOLO v9 Tiny 256 (Fastest)</option>
                                        <option value="yolo-v9-t-384-license-plate-end2end">YOLO v9 Tiny 384</option>
                                        <option value="yolo-v9-t-416-license-plate-end2end">YOLO v9 Tiny 416</option>
                                        <option value="yolo-v9-t-512-license-plate-end2end">YOLO v9 Tiny 512</option>
                                        <option value="yolo-v9-t-640-license-plate-end2end">YOLO v9 Tiny 640 (Recommended)</option>
                                        <option value="yolo-v9-s-608-license-plate-end2end">YOLO v9 Small 608 (Best Accuracy)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ocr_model" class="form-label">OCR Model</label>
                                    <select class="form-select" id="ocr_model" required>
                                        <option value="cct-xs-v1-global-model">CCT XS (Fastest - 3094 PPS)</option>
                                        <option value="cct-s-v1-global-model">CCT Small (Recommended - 1701 PPS)</option>
                                        <option value="cct-xs-relu-v1-global-model">CCT XS ReLU (Fast - 3208 PPS)</option>
                                        <option value="cct-s-relu-v1-global-model">CCT Small ReLU (1764 PPS)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="min_confidence" class="form-label">Minimum Confidence</label>
                                    <input type="number" class="form-control" id="min_confidence" min="0" max="1" step="0.01" required>
                                    <small class="text-muted">Minimum confidence threshold (0.0 - 1.0)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" id="notifications_enabled">
                                <label class="form-check-label" for="notifications_enabled">
                                    <strong>Enable Notifications</strong>
                                </label>
                            </div>

                            <div id="notificationSettings" style="display: none;">
                                <h5 class="card-title mb-3"><i class="bi bi-house"></i> Home Assistant</h5>
                                <div class="mb-4">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="ha_enabled">
                                        <label class="form-check-label" for="ha_enabled">
                                            Enable Home Assistant Webhook
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="ha_webhook" class="form-label">Webhook URL</label>
                                        <input type="url" class="form-control" id="ha_webhook" placeholder="https://homeassistant.local/api/webhook/...">
                                        <small class="text-muted">Create a webhook automation in HA, then paste the URL here</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testNotification('home_assistant')">
                                        <i class="bi bi-send"></i> Test Home Assistant
                                    </button>
                                </div>

                                <h5 class="card-title mb-3"><i class="bi bi-telegram"></i> Telegram</h5>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="telegram_enabled">
                                        <label class="form-check-label" for="telegram_enabled">
                                            Enable Telegram Bot
                                        </label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="telegram_token" class="form-label">Bot Token</label>
                                            <input type="text" class="form-control" id="telegram_token" placeholder="123456:ABC-DEF...">
                                            <small class="text-muted">Get from @BotFather on Telegram</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                            <input type="text" class="form-control" id="telegram_chat_id" placeholder="123456789">
                                            <small class="text-muted">Your Telegram user/group ID</small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testNotification('telegram')">
                                        <i class="bi bi-send"></i> Test Telegram
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Control Tab -->
                <div class="tab-pane fade" id="camera-control" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Current Camera Settings</h5>
                            <p class="text-muted mb-4">Apply real-time camera ISP settings (takes effect immediately)</p>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="current_exposure" class="form-label">Exposure Mode</label>
                                    <select class="form-select" id="current_exposure">
                                        <option value="Auto">Auto</option>
                                        <option value="Manual">Manual</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="current_daynight" class="form-label">Day/Night Mode</label>
                                    <select class="form-select" id="current_daynight">
                                        <option value="Auto">Auto</option>
                                        <option value="Color">Color</option>
                                        <option value="Black&White">Black & White</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="current_binning" class="form-label">Binning Mode</label>
                                    <select class="form-select" id="current_binning">
                                        <option value="0">Disabled</option>
                                        <option value="1">Enabled</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="current_nr3d" class="form-label">3D DNR</label>
                                    <select class="form-select" id="current_nr3d">
                                        <option value="0">Disabled</option>
                                        <option value="1">Enabled</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="applyCurrentSettings()">
                                <i class="bi bi-check-circle"></i> Apply Settings Now
                            </button>
                        </div>
                    </div>

                    <!-- Recording Settings -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Recording Settings</h5>
                            <p class="text-muted mb-4">Configure camera settings to apply before and after recording</p>

                            <!-- Before Recording -->
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="before_recording_enabled">
                                <label class="form-check-label" for="before_recording_enabled">
                                    <strong>Enable Before Recording Settings</strong>
                                </label>
                            </div>

                            <div id="beforeRecordingSettings" style="display: none;">
                                <p class="text-muted small">Settings to apply when recording starts:</p>
                                <div class="row mb-3">
                                    <div class="col-md-3 mb-3">
                                        <label for="before_exposure" class="form-label">Exposure Mode</label>
                                        <select class="form-select" id="before_exposure" onchange="toggleBeforeGainShutter()">
                                            <option value="Auto">Auto</option>
                                            <option value="Manual">Manual</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="before_daynight" class="form-label">Day/Night Mode</label>
                                        <select class="form-select" id="before_daynight">
                                            <option value="Auto">Auto</option>
                                            <option value="Color">Color</option>
                                            <option value="Black&White">Black & White</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="before_binning" class="form-label">Binning Mode</label>
                                        <select class="form-select" id="before_binning">
                                            <option value="0">Disabled</option>
                                            <option value="1">Enabled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="before_nr3d" class="form-label">3D DNR</label>
                                        <select class="form-select" id="before_nr3d">
                                            <option value="0">Disabled</option>
                                            <option value="1">Enabled</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3" id="beforeGainShutterSection" style="display: none;">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Gain Range (Manual Mode Only)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="before_gain_min" min="1" max="100" placeholder="Min">
                                                <small class="text-muted">Min</small>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="before_gain_max" min="1" max="100" placeholder="Max">
                                                <small class="text-muted">Max (1-40 recommended)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Shutter Range (Manual Mode Only)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="before_shutter_min" min="0" max="125" placeholder="Min">
                                                <small class="text-muted">Min</small>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="before_shutter_max" min="0" max="125" placeholder="Max">
                                                <small class="text-muted">Max</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- After Recording -->
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="after_recording_enabled">
                                <label class="form-check-label" for="after_recording_enabled">
                                    <strong>Enable After Recording Settings</strong>
                                </label>
                            </div>

                            <div id="afterRecordingSettings" style="display: none;">
                                <p class="text-muted small">Settings to restore after recording completes:</p>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="after_exposure" class="form-label">Exposure Mode</label>
                                        <select class="form-select" id="after_exposure">
                                            <option value="Auto">Auto</option>
                                            <option value="Manual">Manual</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="after_daynight" class="form-label">Day/Night Mode</label>
                                        <select class="form-select" id="after_daynight">
                                            <option value="Auto">Auto</option>
                                            <option value="Color">Color</option>
                                            <option value="Black&White">Black & White</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="after_binning" class="form-label">Binning Mode</label>
                                        <select class="form-select" id="after_binning">
                                            <option value="0">Disabled</option>
                                            <option value="1">Enabled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="after_nr3d" class="form-label">3D DNR</label>
                                        <select class="form-select" id="after_nr3d">
                                            <option value="0">Disabled</option>
                                            <option value="1">Enabled</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">System Configuration</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="log_level" class="form-label">Log Level</label>
                                    <select class="form-select" id="log_level" required>
                                        <option value="DEBUG">DEBUG (Verbose)</option>
                                        <option value="INFO">INFO (Recommended)</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Save Button (fixed at bottom) -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Changes will be applied instantly without restarting
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Save & Apply Changes
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Load configuration on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        loadCurrentCameraSettings();
        checkRTSPStatus();
        
        // Toggle notification settings visibility
        document.getElementById('notifications_enabled').addEventListener('change', function() {
            document.getElementById('notificationSettings').style.display = this.checked ? 'block' : 'none';
        });

        // Toggle recording settings visibility
        document.getElementById('before_recording_enabled').addEventListener('change', function() {
            const isVisible = this.checked;
            document.getElementById('beforeRecordingSettings').style.display = isVisible ? 'block' : 'none';
            if (isVisible) {
                // Set defaults if fields are empty
                if (!document.getElementById('before_exposure').value) {
                    document.getElementById('before_exposure').value = 'Manual';
                    document.getElementById('before_daynight').value = 'Black&White';
                    document.getElementById('before_binning').value = '0';
                    document.getElementById('before_nr3d').value = '0';
                    document.getElementById('before_gain_min').value = '1';
                    document.getElementById('before_gain_max').value = '40';
                    document.getElementById('before_shutter_min').value = '1';
                    document.getElementById('before_shutter_max').value = '4';
                }
                toggleBeforeGainShutter();
            }
        });

        document.getElementById('after_recording_enabled').addEventListener('change', function() {
            const isVisible = this.checked;
            document.getElementById('afterRecordingSettings').style.display = isVisible ? 'block' : 'none';
            if (isVisible) {
                // Set defaults if fields are empty
                if (!document.getElementById('after_exposure').value) {
                    document.getElementById('after_exposure').value = 'Auto';
                    document.getElementById('after_daynight').value = 'Black&White';
                    document.getElementById('after_binning').value = '1';
                    document.getElementById('after_nr3d').value = '0';
                }
            }
        });

        // RTSP toggle
        document.getElementById('rtsp_enabled').addEventListener('change', function() {
            toggleRTSP(this.checked);
        });
    });

    async function loadCurrentCameraSettings() {
        try {
            const response = await fetch('/api/camera/settings');
            const data = await response.json();
            
            if (data.success && data.settings) {
                const settings = data.settings;
                document.getElementById('current_exposure').value = settings.exposure || 'Auto';
                document.getElementById('current_daynight').value = settings.dayNight || 'Auto';
                document.getElementById('current_binning').value = settings.binningMode || 0;
                document.getElementById('current_nr3d').value = settings.nr3d || 0;
            }
        } catch (error) {
            console.error('Failed to load current camera settings:', error);
        }
    }

    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();

            // Camera settings
            document.getElementById('camera_name').value = config.camera?.name || '';
            document.getElementById('camera_host').value = config.camera?.host || '';
            document.getElementById('camera_username').value = config.camera?.username || '';
            document.getElementById('camera_password').value = config.camera?.password || '';
            document.getElementById('camera_channel').value = config.camera?.channel || 0;
            document.getElementById('recording_duration').value = config.camera?.recording_duration || 3;

            // ALPR settings
            document.getElementById('detection_model').value = config.alpr?.detection_model || 'yolo-v9-t-640-license-plate-end2end';
            document.getElementById('ocr_model').value = config.alpr?.ocr_model || 'cct-s-v1-global-model';
            document.getElementById('min_confidence').value = config.alpr?.min_confidence || 0.9;

            // System settings
            document.getElementById('log_level').value = config.system?.log_level || 'INFO';

            // Notifications
            const notifEnabled = config.notifications?.enabled || false;
            document.getElementById('notifications_enabled').checked = notifEnabled;
            document.getElementById('notificationSettings').style.display = notifEnabled ? 'block' : 'none';
            
            document.getElementById('ha_enabled').checked = config.notifications?.home_assistant?.enabled || false;
            document.getElementById('ha_webhook').value = config.notifications?.home_assistant?.webhook_url || '';
            
            document.getElementById('telegram_enabled').checked = config.notifications?.telegram?.enabled || false;
            document.getElementById('telegram_token').value = config.notifications?.telegram?.bot_token || '';
            document.getElementById('telegram_chat_id').value = config.notifications?.telegram?.chat_id || '';

            // Recording settings
            const beforeEnabled = config.recording?.before_recording_enabled || false;
            const afterEnabled = config.recording?.after_recording_enabled || false;
            
            document.getElementById('before_recording_enabled').checked = beforeEnabled;
            document.getElementById('beforeRecordingSettings').style.display = beforeEnabled ? 'block' : 'none';
            
            document.getElementById('after_recording_enabled').checked = afterEnabled;
            document.getElementById('afterRecordingSettings').style.display = afterEnabled ? 'block' : 'none';

            if (config.recording?.before_recording_settings) {
                const before = config.recording.before_recording_settings;
                document.getElementById('before_exposure').value = before.exposure || 'Manual';
                document.getElementById('before_daynight').value = before.dayNight || 'Black&White';
                document.getElementById('before_binning').value = before.binningMode !== undefined ? before.binningMode : 0;
                document.getElementById('before_nr3d').value = before.nr3d !== undefined ? before.nr3d : 0;
                document.getElementById('before_gain_min').value = before.gain?.min || 1;
                document.getElementById('before_gain_max').value = before.gain?.max || 40;
                document.getElementById('before_shutter_min').value = before.shutter?.min || 1;
                document.getElementById('before_shutter_max').value = before.shutter?.max || 4;
                toggleBeforeGainShutter();
            }

            if (config.recording?.after_recording_settings) {
                const after = config.recording.after_recording_settings;
                document.getElementById('after_exposure').value = after.exposure || 'Auto';
                document.getElementById('after_daynight').value = after.dayNight || 'Black&White';
                document.getElementById('after_binning').value = after.binningMode !== undefined ? after.binningMode : 1;
                document.getElementById('after_nr3d').value = after.nr3d !== undefined ? after.nr3d : 0;
            }

        } catch (error) {
            showAlert('Failed to load configuration: ' + error.message, 'danger');
        }
    }

    async function checkRTSPStatus() {
        try {
            const response = await fetch('/api/camera/rtsp/status');
            const data = await response.json();
            
            const statusEl = document.getElementById('rtsp_status');
            const toggleEl = document.getElementById('rtsp_enabled');
            
            if (data.success) {
                toggleEl.checked = data.enabled;
                toggleEl.disabled = false;
                statusEl.innerHTML = data.enabled ? 
                    '<i class="bi bi-check-circle text-success"></i> RTSP Enabled (Port ' + data.port + ')' :
                    '<i class="bi bi-x-circle text-danger"></i> RTSP Disabled';
            } else {
                statusEl.innerHTML = '<i class="bi bi-exclamation-circle text-warning"></i> Could not check RTSP status';
            }
        } catch (error) {
            document.getElementById('rtsp_status').innerHTML = '<i class="bi bi-exclamation-circle text-warning"></i> Could not check RTSP status';
        }
    }

    async function toggleRTSP(enable) {
        try {
            const response = await fetch('/api/camera/rtsp/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable: enable })
            });
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
                checkRTSPStatus();
            } else {
                showAlert('Failed to toggle RTSP: ' + data.message, 'danger');
                document.getElementById('rtsp_enabled').checked = !enable;
            }
        } catch (error) {
            showAlert('Error toggling RTSP: ' + error.message, 'danger');
            document.getElementById('rtsp_enabled').checked = !enable;
        }
    }

    async function applyCurrentSettings() {
        const settings = {
            exposure: document.getElementById('current_exposure').value,
            dayNight: document.getElementById('current_daynight').value,
            binningMode: parseInt(document.getElementById('current_binning').value),
            nr3d: parseInt(document.getElementById('current_nr3d').value)
        };

        try {
            const response = await fetch('/api/camera/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const data = await response.json();
            
            if (data.success) {
                showAlert('Camera settings applied successfully!', 'success');
                // Reload current settings to confirm
                await loadCurrentCameraSettings();
            } else {
                showAlert('Failed to apply settings: ' + data.message, 'danger');
            }
        } catch (error) {
            showAlert('Error applying settings: ' + error.message, 'danger');
        }
    }

    async function testNotification(service) {
        try {
            const response = await fetch('/api/notifications/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service: service })
            });
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert('Test failed: ' + data.message, 'danger');
            }
        } catch (error) {
            showAlert('Error sending test: ' + error.message, 'danger');
        }
    }

    // Form submission
    document.getElementById('configForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving & Applying...';

        const config = {
            camera: {
                name: document.getElementById('camera_name').value,
                host: document.getElementById('camera_host').value,
                username: document.getElementById('camera_username').value,
                password: document.getElementById('camera_password').value,
                channel: parseInt(document.getElementById('camera_channel').value),
                recording_duration: parseInt(document.getElementById('recording_duration').value)
            },
            alpr: {
                detection_model: document.getElementById('detection_model').value,
                ocr_model: document.getElementById('ocr_model').value,
                min_confidence: parseFloat(document.getElementById('min_confidence').value)
            },
            system: {
                log_level: document.getElementById('log_level').value,
                database_path: 'data/anpr.db',
                log_file: 'logs/anpr.log',
                web_host: '0.0.0.0',
                web_port: 5001
            },
            notifications: {
                enabled: document.getElementById('notifications_enabled').checked,
                home_assistant: {
                    enabled: document.getElementById('ha_enabled').checked,
                    webhook_url: document.getElementById('ha_webhook').value
                },
                telegram: {
                    enabled: document.getElementById('telegram_enabled').checked,
                    bot_token: document.getElementById('telegram_token').value,
                    chat_id: document.getElementById('telegram_chat_id').value
                }
            },
            recording: {
                before_recording_enabled: document.getElementById('before_recording_enabled').checked,
                before_recording_settings: {
                    exposure: document.getElementById('before_exposure').value,
                    dayNight: document.getElementById('before_daynight').value,
                    binningMode: parseInt(document.getElementById('before_binning').value),
                    nr3d: parseInt(document.getElementById('before_nr3d').value),
                    gain: {
                        min: parseInt(document.getElementById('before_gain_min').value) || 1,
                        max: parseInt(document.getElementById('before_gain_max').value) || 100
                    },
                    shutter: {
                        min: parseInt(document.getElementById('before_shutter_min').value) || 0,
                        max: parseInt(document.getElementById('before_shutter_max').value) || 125
                    }
                },
                after_recording_enabled: document.getElementById('after_recording_enabled').checked,
                after_recording_settings: {
                    exposure: document.getElementById('after_exposure').value,
                    dayNight: document.getElementById('after_daynight').value,
                    binningMode: parseInt(document.getElementById('after_binning').value),
                    nr3d: parseInt(document.getElementById('after_nr3d').value)
                }
            }
        };

        try {
            // Step 1: Save configuration
            const saveResponse = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            const saveData = await saveResponse.json();

            if (!saveData.success) {
                showAlert('Failed to save configuration: ' + saveData.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            // Step 2: Trigger reload
            const reloadResponse = await fetch('/api/reload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const reloadData = await reloadResponse.json();

            if (reloadData.success) {
                showAlert('✓ Configuration saved and applied successfully!', 'success');
                // Reload current camera settings after reload
                setTimeout(() => loadCurrentCameraSettings(), 2000);
            } else {
                showAlert('⚠️ Configuration saved but reload failed: ' + reloadData.message, 'warning');
            }

            // Re-enable button after 3 seconds
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 3000);

        } catch (error) {
            showAlert('Error: ' + error.message, 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    function toggleBeforeGainShutter() {
        const exposure = document.getElementById('before_exposure').value;
        const gainShutterSection = document.getElementById('beforeGainShutterSection');
        gainShutterSection.style.display = (exposure === 'Manual') ? 'flex' : 'none';
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.getElementById('alertContainer').innerHTML = alertHtml;
        
        // Scroll to top to show alert
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
{% endblock %}
